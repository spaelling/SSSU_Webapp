<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
      height: 100vh;
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .container {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      max-width: 600px;
      margin: 1rem;
    }
    h1 {
      color: #2c3e50;
      margin-bottom: 1rem;
    }
    p {
      color: #34495e;
      line-height: 1.6;
    }
    .loader {
      width: 48px;
      height: 48px;
      border: 5px solid #f3f3f3;
      border-radius: 50%;
      border-top: 5px solid #3498db;
      animation: spin 1s linear infinite;
      margin: 2rem auto;
    }
    .hidden {
      display: none !important;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <title>Auto Sign-In with Session Logic</title>
  <script src="https://alcdn.msauth.net/browser/2.19.0/js/msal-browser.min.js"></script>
  <script>
    const sessionCookieName = "sessionActive";

    function isSessionCookieSet() {
      return document.cookie.split("; ")
        .some(cookie => cookie.startsWith(sessionCookieName + "="));
    }

    function setSessionCookie() {
      document.cookie = sessionCookieName + "=1; path=/; secure";
    }

    // MSAL config WITHOUT the /authorize path
    const msalConfig = {
      auth: {
        clientId: "5ea2df38-0197-4781-bfbc-600693237ef9",
        authority: "https://login.microsoftonline.com/690e25b4-8c5e-4a10-a32e-523da88a4c99",
        knownAuthorities: ["login.microsoftonline.com"],
        redirectUri: "https://lively-moss-09d5acf03.2.azurestaticapps.net"
      },
      cache: {
        cacheLocation: "localStorage",
        storeAuthStateInCookie: false
      }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    msalInstance.handleRedirectPromise()
        .then(response => {
            if (response) {
                console.log("Login successful:", response);
                setSessionCookie();
                // Show the welcome container
                document.getElementById('welcomeContainer').classList.remove('hidden');
                // Add delay before redirect
                setTimeout(() => {
                    window.location.href = "https://lively-moss-09d5acf03.2.azurestaticapps.net";
                }, 5000);
            } else {
                if (!isSessionCookieSet()) {
                    localStorage.clear();
                }
                // Pass user flow name in extraQueryParameters
                msalInstance.loginRedirect({
                    scopes: ["openid", "profile", "email"],
                    extraQueryParameters: { p: "Egmont-01" }
                });
            }
        })
        .catch(error => {
            console.error("Login error:", error);
        });
  </script>
</head>
<body>
    <div class="container hidden" id="welcomeContainer">
      <h1>Egmont SSU</h1>
      <p id="usernameDisplay"></p>
      <p>You've successfully completed the Microsoft Entra ID self-service sign-up process.</p>
      <p>Your account has been created and verified through our secure authentication system.</p>
      <div class="loader"></div>
      <p><small>If you're not redirected automatically, please wait a few seconds...</small></p>
    </div>
    <script>
      function decodeJwt(token) {
      try {
        const payload = token.split('.')[1];
        const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
        return JSON.parse(decoded);
      } catch (e) {
        return null;
      }
      }

      function showUsername(idToken) {
      const decoded = decodeJwt(idToken);
      if (decoded && decoded.name) {
        document.getElementById('usernameDisplay').textContent = `Welcome, ${decoded.name}!`;
      } else if (decoded && decoded.preferred_username) {
        document.getElementById('usernameDisplay').textContent = `Welcome, ${decoded.preferred_username}!`;
      }
      }

      msalInstance.handleRedirectPromise()
      .then(response => {
        if (response && response.idToken) {
        showUsername(response.idToken);
        }
      });
    </script>
</body>
</html>
